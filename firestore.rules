rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── CORE SECURITY FUNCTIONS ───────────────────────────────────────────────
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Safely check if the user doc exists, then safely check the role
    function isAdmin() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      return isSignedIn() 
        && exists(userPath) 
        && get(userPath).data.get('role', 'student') == 'admin';
    }

    // Safely check if the user doc exists, then safely check the ban status
    function isNotBanned() {
      let userPath = /databases/$(database)/documents/users/$(request.auth.uid);
      // If the doc doesn't exist, we assume they aren't banned yet. 
      // Change to `exists(userPath) &&` if they MUST have a profile to read.
      return isSignedIn() 
        && (!exists(userPath) || get(userPath).data.get('isBanned', false) != true);
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    // ── USERS & PROFILES ──────────────────────────────────────────────────────
    match /users/{uid} {
      allow read: if isOwner(uid) || isAdmin();

      // On signup: force student role and active status
      allow create: if isOwner(uid)
        && request.resource.data.role == 'student'
        && request.resource.data.isBanned == false;

      // Update logic: 
      // 1. Admins: can edit everything EXCEPT they cannot remove their own admin role.
      // 2. Students: can only edit non-sensitive fields (name, phone).
      allow update: if (isAdmin() && (uid != request.auth.uid || request.resource.data.role == 'admin'))
        || (isOwner(uid) && isNotBanned()
            && !request.resource.data.diff(resource.data).affectedKeys()
                .hasAny(['role', 'isBanned', 'grade', 'email']));

      allow delete: if isAdmin() && uid != request.auth.uid;
    }

    // ── EDUCATIONAL CONTENT (LECTURES, ASSIGNMENTS, QUIZZES) ──────────────────
    
    // Lectures & Lessons
    match /lectures/{docId} {
      allow read: if isNotBanned() && (resource.data.isActive == true || isAdmin());
      allow write: if isAdmin();
    }

    // Assignments Builder
    match /assignments/{docId} {
      allow read: if isNotBanned() && (resource.data.isActive == true || isAdmin());
      allow write: if isAdmin();
    }

    // Quizzes Builder
    match /quizzes/{docId} {
      allow read: if isNotBanned() && (resource.data.isActive == true || isAdmin());
      allow write: if isAdmin();
    }

    // ── RESULTS & PERFORMANCE (AUTO-GRADED) ───────────────────────────────────

    match /assignmentsResult/{docId} {
      allow read: if isNotBanned() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if isNotBanned() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /quizzesResult/{docId} {
      allow read: if isNotBanned() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if isNotBanned() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ── ACTIVITY & LOGS ───────────────────────────────────────────────────────

    match /submissions/{docId} {
      allow read: if isNotBanned() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow create: if isNotBanned() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /attendances/{docId} {
      allow read: if isNotBanned() && (isAdmin() || resource.data.userId == request.auth.uid);
      allow write: if isAdmin();
    }

    // System Configuration
    match /config/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}